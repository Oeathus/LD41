<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Acey Duecy Engine</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
  </head>
  <body>
      <div>
          <h2 style="display: inline-block;">Dealers Card:</h2>
          <h3 id="dealersCard" style="display: inline-block;"></h3>
      </div>
      <div>
          <h2 style="display: inline-block;">Your first card:</h2>
          <h3 id="yourCard1" style="display: inline-block;"></h3>
      </div>
      <div>
          <h2 style="display: inline-block;">Your second Card:</h2>
          <h3 id="yourCard2" style="display: inline-block;"></h3>
      </div>
      <div>
          <h2 style="display: inline-block;">Bonus Card:</h2>
          <h3 id="bonusCard" style="display: inline-block;"></h3>
      </div>
      <p id="wallet"></p>
      <button id="bet">Bet</button>
      <button id="skip">Skip</button>
      <button id="next" style="display: none;">Next Hand</button>
      <script>
        'use strict';
        const SUITS = ['Spades', 'Clubs', 'Hearts', 'Diamonds'];
        const NAMES = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'Jack', 'Queen', 'King', 'Ace'];

        function DOMLink(elem) {
            this.elem = elem;
            this.val = null;
            this.update = function(val = null) {
                if (val != null) {
                    this.val = val;
                }
                if (this.val != null) {
                    this.elem.innerText = this.val.toString();
                } else {
                    this.elem.innerText = "";
                }
            };
            this.empty = function() {
                this.val = null;
                this.elem.innerText = "";
            };
        }

        function Card(value, name, suit) {
            this.value = value;
            this.name = name;
            this.suit = suit;
            this.toString = function() {
                return this.name + " of " + this.suit;
            };
            this.compare = function(otherCard = null) {
                if (otherCard != null) {
                    if (this.value > otherCard.value) {
                        return 1;
                    } else if (this.value < otherCard.value) {
                        return -1;
                    } else {
                        return 0;
                    }
                } else {
                    return null;
                }
            }
        }

        function Wallet(elem, startingAmount = 20.00) {
            this.elem = elem;
            this.value = startingAmount;
            this.update = function(val = NaN){
                if (!isNaN(val)) {
                    this.value += val;
                }
                this.elem.innerText = "$" + this.value.toFixed(2).toString();
            }
        }
        
        let dealersCard = new DOMLink(document.getElementById("dealersCard"));
        let yourCard1 = new DOMLink(document.getElementById("yourCard1"));
        let yourCard2 = new DOMLink(document.getElementById("yourCard2"));
        let bonusCard = new DOMLink(document.getElementById("bonusCard"));
        let wallet = new Wallet(document.getElementById("wallet"));
        let bet = document.getElementById("bet");
        let skip = document.getElementById("skip");
        let next = document.getElementById("next");
        let deck;

        function getDeck() {
            let cards = [];

            for(let suit = 0; suit < 4; ++suit) {
                for(let name = 0; name < 13; ++name) {
                    cards.push(new Card(name + 1, NAMES[name], SUITS[suit]));
                }
            }

            return cards;
        }

        function checkDeckSize() {
            if (deck.length < 4) {
                let tmpDeck = getDeck();
                d3.shuffle(tmpDeck);
                deck.concat(tmpDeck);
            }
        }

        function initialize() {
            deck = getDeck();
            d3.shuffle(deck);
            dealersCard.update(deck.pop());
            yourCard1.update(deck.pop());
            wallet.update();
        }

        function endHand() {
            bet.style.display = "none";
            skip.style.display = "none";
            next.style.display = "inline-block";
        }

        initialize();

        bet.addEventListener('click', function(e) {
            let amount = NaN;

            while (isNaN(amount) || amount < 0.01 || amount > wallet.value) {
                amount = parseFloat(prompt("Bet amount:", wallet.value.toString()));
            }

            checkDeckSize();

            yourCard2.update(deck.pop());
            if ((yourCard2.val.compare(dealersCard.val) == 1 && yourCard2.val.compare(yourCard1.val) == -1) ||
                (yourCard2.val.compare(dealersCard.val) == -1 && yourCard2.val.compare(yourCard1.val) == 1)) {
                bonusCard.update(deck.pop());
                if ((bonusCard.val.compare(dealersCard.val) == 1 && bonusCard.val.compare(yourCard1.val) == -1) ||
                (bonusCard.val.compare(dealersCard.val) == -1 && bonusCard.val.compare(yourCard1.val) == 1)) {
                    wallet.update(amount * 2);
                } else {
                    wallet.update(amount);
                }
            } else {
                wallet.update(-1 * amount);
            }

            endHand();
        });

        skip.addEventListener('click', function(e) {
            checkDeckSize();
            yourCard2.update(deck.pop());
            endHand();
        });

        next.addEventListener('click', function(e) {
            dealersCard.update(deck.pop());
            yourCard1.update(deck.pop());
            yourCard2.empty();
            bet.style.display = "inline-block";
            skip.style.display = "inline-block";
            next.style.display = "none";
        });
      </script>
  </body>
</html>
