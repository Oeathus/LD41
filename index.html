<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 8</title>
    <script src="//cdn.jsdelivr.net/phaser/2.6.2/phaser.min.js"></script>
    <script src="//d3js.org/d3.v5.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <script type="text/javascript">
        const SUITS = ['Spades', 'Clubs', 'Hearts', 'Diamonds'];
        const NAMES = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'Jack', 'Queen', 'King', 'Ace'];

        function DOMLink() {
            this.elem = null;
            this.val = null;
            this.update = function (val = null) {
                if (val !== null) {
                    this.val = val;
                }
                if (this.val === null && typeof this.val === "object") {
                    this.elem.setText("");
                } else {
                    this.elem.setText(this.val.toString());
                }
            };
            this.empty = function () {
                this.val = null;
                this.elem.setText("");
            };
        }

        function Card(value, name, suit) {
            this.value = value;
            this.name = name;
            this.suit = suit;
            this.toString = function () {
                return this.name + " of " + this.suit;
            };
            this.compare = function (otherCard = null) {
                if (otherCard !== null) {
                    if (this.value > otherCard.value) {
                        return 1;
                    } else if (this.value < otherCard.value) {
                        return -1;
                    } else {
                        return 0;
                    }
                } else {
                    return null;
                }
            }
        }

        function Wallet(startingAmount = 20.00) {
            this.elem = null;
            this.value = startingAmount;
            this.toString = function () {
                return "$" + this.value.toFixed(2).toString();
            };
            this.update = function (val = NaN) {
                if (!isNaN(val)) {
                    this.value += val;
                }
                if (this.elem === null && typeof this.elem === "object") {

                } else {
                    this.elem.setText(this.toString());
                }
            };
        }

        var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'prison-cats', { preload: preload, create: create, render: render });
        
        
        let deck;
        let dealersCard = new DOMLink();
        let yourCard1 = new DOMLink();
        let yourCard2 = new DOMLink();
        let bonusCard = new DOMLink();
        let wallet = new Wallet();
        let betAmount = 1;

        var catnip = 0;
        var cigs = 0;
        var wine = 0;
        var tuna = 0;

        var catnipprice = 40;
        var cigsprice = 10;
        var wineprice = 5;
        var tunaprice = 1.5;

        var nicfit = 1;
        var sober = 1;
        var hungry = 1;
        var bored = 1;

        var catattack = 0;

        function preload() {
            game.load.image('background', 'assets/images/ruffhud1.png');
            game.load.image('pcat_neutral', 'assets/images/tempcat.png');
            game.load.image('betButton', 'assets/images/betButton.png');
            game.load.image('nextButton', 'assets/images/nextButton.png');

            game.load.image('eyel', 'assets/images/eyel.png');
            game.load.image('eyer', 'assets/images/eyer.png');
            
            game.load.bitmapFont('child', 'assets/images/ashcan.png', 'assets/images/ashcan.fnt');
        }

        function create() {
            game.physics.startSystem(Phaser.Physics.ARCADE);
            game.stage.backgroundColor = '#ffffff';
            background = game.add.tileSprite(0, 0, 800, 600, 'background');

            catnipL = game.add.bitmapText(20, 20, 'child', 'catnip: ' + catnip.toFixed(2), 24);
            cigsL = game.add.text(20, 40, 'cigs: ' + cigs.toFixed(2), { font: "12px Arial", fill: "#000000", align: "center" });
            wineL = game.add.text(20, 60, 'wine: ' + wine.toFixed(2), { font: "12px Arial", fill: "#000000", align: "center" });
            tunaL = game.add.text(20, 80, 'tuna: ' + tuna.toFixed(2), { font: "12px Arial", fill: "#000000", align: "center" });

            nicfitL = game.add.text(20, 120, 'nicfit: ' + nicfit.toFixed(2), { font: "12px Arial", fill: "#000000", align: "center" });
            soberL = game.add.text(20, 140, 'sober: ' + sober.toFixed(2), { font: "12px Arial", fill: "#000000", align: "center" });
            hungryL = game.add.text(20, 160, 'hungry: ' + hungry.toFixed(2), { font: "12px Arial", fill: "#000000", align: "center" });
            boredL = game.add.text(20, 180, 'bored: ' + bored.toFixed(2), { font: "12px Arial", fill: "#000000", align: "center" });

            catattackL = game.add.text(20, 200, 'catattack: ' + catattack.toFixed(2), { font: "12px Arial", fill: "#000000", align: "center" });

            wallet.elem = game.add.bitmapText(20, 540, 'child', wallet.toString(), 24);
            betL = game.add.bitmapText(20, 566, 'child', "Bet: $" + betAmount.toFixed(2).toString(), 24);

            righteye = game.add.sprite(255, 145, 'eyer');
            righteye.anchor.set(0.5);
            righteye.events.onInputDown.add(() => --bored, this);
            righteye.scale.setTo(0.55, 0.55);

            lefteye = game.add.sprite(174, 124, 'eyel');
            lefteye.anchor.set(0.5);
            lefteye.scale.setTo(0.6, 0.6);

            petButton = game.add.sprite(game.world.centerX, game.world.centerY - 60, 'pcat_neutral');
            petButton.anchor.set(0.5);
            petButton.inputEnabled = true;
            petButton.events.onInputDown.add(() => --bored, this);
            petButton.scale.setTo(0.75, 0.75);

            betButton = game.add.sprite(240, 500, 'betButton');
            betButton.anchor.set(0.5);
            betButton.inputEnabled = true;
            betButton.events.onInputDown.add(betButtonAction, this);

            dealersCard.elem = game.add.text(315, 475, "Dealers Card", { font: "16px Arial", fill: "#000000", align: "left" });
            yourCard1.elem = game.add.text(435, 490, "Your Card", { font: "16px Arial", fill: "#000000", align: "left" });
            bonusCard.elem = game.add.text(435, 535, "", { font: "16px Arial", fill: "#000000", align: "left" });

            yourCard2.elem = game.add.text(465, 525, 'Draw', { font: "16px Arial", fill: "#000000", align: "center" });
            yourCard2.elem.anchor.set(0.5);
            yourCard2.elem.inputEnabled = true;
            yourCard2.elem.events.onInputDown.add(drawSecondCard, this);

            nextButton = game.add.sprite(605, 480, 'nextButton');
            nextButton.anchor.set(0.5);
            nextButton.inputEnabled = true;
            nextButton.events.onInputDown.add(nextButtonAction, this);

            buyCatnipButton = game.add.text(300, 50, "Buy Catnip", { font: "16px Arial", fill: "#000000", align: "left" });
            buyCatnipButton.anchor.set(0.5);
            buyCatnipButton.inputEnabled = true;
            buyCatnipButton.events.onInputDown.add(buycatnip, this);

            buyCigsButton = game.add.text(300, 100, "Buy Cigs", { font: "16px Arial", fill: "#000000", align: "left" });
            buyCigsButton.anchor.set(0.5);
            buyCigsButton.inputEnabled = true;
            buyCigsButton.events.onInputDown.add(buycigs, this);

            buyWineButton = game.add.text(450, 50, "Buy Wine", { font: "16px Arial", fill: "#000000", align: "left" });
            buyWineButton.anchor.set(0.5);
            buyWineButton.inputEnabled = true;
            buyWineButton.events.onInputDown.add(buywine, this);

            buyTunaButton = game.add.text(450, 100, "Buy Tuna", { font: "16px Arial", fill: "#000000", align: "left" });
            buyTunaButton.anchor.set(0.5);
            buyTunaButton.inputEnabled = true;
            buyTunaButton.events.onInputDown.add(buytuna, this);

            deck = getDeck();
            d3.shuffle(deck);
            dealersCard.update(deck.pop());
            yourCard1.update(deck.pop());
            wallet.update();
            //  Here we'll create a basic looped event.
            //  A looped event is like a repeat event but with no limit, it will literally repeat itself forever, or until you stop it.

            //  The first parameter is how long to wait before the event fires. In this case 1 second (you could pass in 1000 as the value as well.)
            //  The next two parameters are the function to call ('updateCounter') and the context under which that will happen.

            game.time.events.loop(Phaser.Timer.SECOND*5, updateCounter, this);
        }

        function updateCounter() {
            bored += .01;
            sober += .01;
            hungry += .01;
            nicfit += .01;


            if (catnip > 0) {
                catnip -= .01;

                bored -= .03;
                hungry += .01;
                sober -= .03;

            } else {
                catnip = 0;
            }

            if (cigs > 0) {
                cigs -= .01

                hungry -= .01;
                nicfit -= .05;
                sober += .01;
            } else {
                cigs = 0;
            }

            if (wine > 0) {
                wine -= .01

                bored -= .03;
                nicfit += .01;
                sober -= .03;

            } else {
                wine = 0;
            }

            if (tuna > 0) {
                tuna -= .01;

                hungry -= .06;
                sober += .01;

            } else {
                tuna = 0;
            }

            if (nicfit < 0) {
                nicfit = 0;
            }
            if (sober < 0) {
                sober = 0;
            }
            if (hungry < 0) {
                hungry = 0;
            }
            if (bored < 0) {
                bored = 0;
            }

            if (nicfit > 1) {
                nicfit = 1;
            }
            if (sober > 1) {
                sober = 1;
            }
            if (hungry > 1) {
                hungry = 1;
            }
            if (bored > 1) {
                bored = 1;
            }

            catattack = (4 - (nicfit + sober + hungry + bored))/4;



            catnipL.setText('Catnip: ' + (catnip * 3.5).toFixed(2));
            cigsL.setText('cigs: ' + (cigs * 20).toFixed(2));
            wineL.setText('wine: ' + (wine * 750).toFixed(2));
            tunaL.setText('tuna: ' + (tuna * 12).toFixed(2));

            nicfitL.setText('nicfit: ' + nicfit.toFixed(2));
            soberL.setText('sober: ' + sober.toFixed(2));
            hungryL.setText('hungry: ' + hungry.toFixed(2));
            boredL.setText('bored: ' + bored.toFixed(2));

            catattackL.setText('bonus: ' + catattack.toFixed(2));
        }

        function render() {
            righteye.rotation = game.physics.arcade.angleToPointer(righteye)-.6;
            lefteye.rotation = game.physics.arcade.angleToPointer(lefteye);
        }

        function buycatnip() {
            if (wallet.value > catnipprice) {
                wallet.value -= catnipprice;
                wallet.update();
                catnipprice *= 1.4;
                catnip++;
            }
        }

        function buycigs() {
            if (wallet.value > cigsprice) {
                wallet.value -= cigsprice;
                wallet.update();
                cigsprice *= 1.05;
                cigs++;
            }
        }

        function buywine() {
            if (wallet.value > wineprice) {
                wallet.value -= wineprice;
                wallet.update();
                wineprice *= 1.7;
                wine++;
            }
        }

        function buytuna() {
            if (wallet.value > tunaprice) {
                wallet.value -= tunaprice;
                wallet.update();
                tunaprice *= 1.2;
                tuna++;
            }
        }

        function getDeck() {
            let cards = [];

            for (let suit = 0; suit < 4; ++suit) {
                for (let name = 0; name < 13; ++name) {
                    cards.push(new Card(name + 1, NAMES[name], SUITS[suit]));
                }
            }

            return cards;
        }

        function checkDeckSize() {
            if (deck.length < 4) {
                let tmpDeck = getDeck();
                d3.shuffle(tmpDeck);
                deck = deck.concat(tmpDeck);
            }
        }

        function endHand() {
            betButton.inputEnabled = false;
            yourCard2.elem.inputEnabled = false;
        }

        function betButtonAction() {
            betAmount = betAmount >= 3 ? 1 : betAmount + 1;
            if (betAmount > wallet.value) {
                betAmount = wallet.value;
            }
            betL.setText("Bet: $" + betAmount.toFixed(2).toString());
        }

        function drawSecondCard() {
            checkDeckSize();
            yourCard2.update(deck.pop());
            if ((yourCard2.val.compare(dealersCard.val) == 1 && yourCard2.val.compare(yourCard1.val) == -1) ||
                (yourCard2.val.compare(dealersCard.val) == -1 && yourCard2.val.compare(yourCard1.val) == 1)) {
                bonusCard.update(deck.pop());
                if ((bonusCard.val.compare(dealersCard.val) == 1 && bonusCard.val.compare(yourCard1.val) == -1) ||
                    (bonusCard.val.compare(dealersCard.val) == -1 && bonusCard.val.compare(yourCard1.val) == 1)) {
                    wallet.update(betAmount * 2);
                } else {
                    wallet.update(betAmount);
                }
            } else {
                wallet.update(-1 * betAmount);
            }

            endHand();
        }

        function nextButtonAction() {
            checkDeckSize();
            if (betButton.inputEnabled) {
                yourCard2.update(deck.pop());
                endHand();
            } else {
                dealersCard.update(deck.pop());
                yourCard1.update(deck.pop());
                yourCard2.empty();
                yourCard2.elem.setText("Draw");
                bonusCard.empty();

                betButton.inputEnabled = true;
                yourCard2.elem.inputEnabled = true;
            }
        }
    </script>
</body>

</html>